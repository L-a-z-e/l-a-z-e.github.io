---
title: Spring Batch - Review(5)
description: 
author: laze
date: 2025-06-26 00:00:02 +0900
categories: [Dev, SpringBatch]
tags: [SpringBatch]
---
**1. `@StepScope` 빈의 생명주기**

- **생성 시점:** `@StepScope`로 선언된 빈은 해당 빈이 실제로 사용되는 **스텝(Step)이 시작될 때** 프록시 객체를 통해 실제 인스턴스가 생성됩니다.
- **소멸 시점:** 해당 **스텝(Step)이 종료될 때** 소멸(또는 스프링 컨테이너의 관점에서 해당 스코프가 종료되어 가비지 컬렉션 대상이 됨)됩니다.
- 이는 각 스텝 실행마다 해당 빈의 새로운 인스턴스가 생성될 수 있음을 의미합니다 (만약 스텝이 여러 번 실행되거나 재시작되는 경우).

**2. `@StepScope`와 `#{jobParameters['...']}` SpEL 주입의 관계**

**값을 주입받는 시점과 빈이 생성되는 시점의 불일치**

- **`JobParameters`의 확정 시점:** `JobParameters`는 `JobLauncher`가 `Job`을 실행하는 **바로 그 시점에 확정**됩니다. 즉, 잡이 시작되어야 그 잡 실행에 사용될 `JobParameters`의 실제 값을 알 수 있습니다.
- **일반적인 스프링 빈(싱글톤 스코프)의 생성 시점:**
  - 별도의 스코프가 지정되지 않은 대부분의 스프링 빈은 기본적으로 **싱글톤(Singleton)** 스코프를 가집니다.
  - 싱글톤 빈은 스프링 **애플리케이션 컨텍스트가 로드될 때 (애플리케이션 시작 시) 단 한 번 생성**되어 컨테이너 내에 계속 유지됩니다.
- **문제점 (싱글톤 빈에서 `#{jobParameters['...']}`를 사용하려고 할 때):**
  1. 애플리케이션이 시작되면서 싱글톤 빈 A가 생성됩니다.
  2. 빈 A의 필드에 `@Value("#{jobParameters['inputFile']}")` 어노테이션이 붙어있다고 가정해봅시다.
  3. 하지만 빈 A가 생성되는 시점에는 **아직 어떤 `Job`이 어떤 `JobParameters`로 실행될지 전혀 알 수 없습니다.** `JobParameters`는 아직 존재하지 않거나, 그 값이 비어있거나, 이전 실행의 값(만약 컨텍스트가 남아있다면)일 수 있습니다.
  4. 따라서 싱글톤 빈이 생성되는 시점에 `#{jobParameters['inputFile']}` 표현식을 평가하려고 하면, 올바른 `JobParameter` 값을 가져올 수 없습니다. 보통은 `null`이 주입되거나, 표현식 평가 오류가 발생할 수 있습니다.
- **`@StepScope`의 해결책 (지연 생성 및 프록시):**
  1. `@StepScope`로 빈 B를 선언하면, 애플리케이션 시작 시에는 빈 B의 **실제 인스턴스가 아닌, 프록시(Proxy) 객체**가 먼저 스프링 컨테이너에 등록되고 다른 곳에 주입됩니다.
  2. 실제로 해당 빈 B를 사용하는 **스텝이 시작되는 시점**이 되어서야, 이 프록시 객체는 **실제 빈 B의 인스턴스를 생성**합니다.
  3. **바로 이 시점 (스텝 시작 시점)에는 현재 실행 중인 `Job`의 `JobParameters`가 이미 확정되어 접근 가능**합니다.
  4. 따라서 `@StepScope` 빈이 (지연되어) 생성될 때, `@Value("#{jobParameters['inputFile']}")` 와 같은 SpEL 표현식이 평가되면, 현재 스텝이 속한 `Job`의 `JobParameters`에서 정확한 값을 찾아 주입할 수 있게 됩니다.

**결론적으로, `@StepScope`를 사용해야 하는 이유는 다음과 같습니다:**

- `JobParameters` (또는 `JobExecutionContext`, `StepExecutionContext`)의 값은 **런타임, 즉 잡이나 스텝이 실제로 실행되는 시점에야 의미를 갖는 값**들입니다.
- 일반적인 싱글톤 빈은 애플리케이션 시작 시점에 생성되므로, 이 런타임 값들에 접근할 수 없습니다.
- `@StepScope`는 빈의 **생성 시점을 실제 스텝 실행 시점까지 지연**시키고, 프록시를 통해 이를 가능하게 함으로써, 런타임에 확정되는 `JobParameters` 등의 값을 안전하게 주입받아 사용할 수 있도록 합니다.

**비유:**

- **싱글톤 빈:** 식당 개업 전에 미리 모든 메뉴판에 오늘의 특선 메뉴 이름을 적어두려고 하는 것과 같습니다. 아직 어떤 특선 메뉴를 할지 정해지지 않았는데 말이죠.
- **`@StepScope` 빈:** 손님이 와서 "오늘의 특선 메뉴 뭐예요?"라고 물어보는 순간(스텝 시작)에, 주방에서 오늘의 특선 메뉴(JobParameters)를 확인하고 메뉴판(빈의 필드)에 적어주는 것과 같습니다.
